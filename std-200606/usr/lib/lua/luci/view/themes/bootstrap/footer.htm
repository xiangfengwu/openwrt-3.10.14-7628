<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008 Jo-Philipp Wich <xm@leipzig.freifunk.net>
Copyright 2012 David Menting <david@nut-bolt.nl>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

-%>
<%
	local disp = require "luci.dispatcher"

	local request  = disp.context.path

	local category = request[1]

	local tree = disp.node()

	local categories = disp.node_childs(tree)
%>
</div>

<style>
  .hide {
    display: none;
  }

  header {
    display: none;
  }

  .maincontent {
    width: 100%;
    height: 100%;
  }

  .cbi-value-title {
    width: 80px !important;
  }

  form .input,
  form .cbi-value-field {
    margin-left: 100px !important;
  }

  #cbi-wifirelay-wifirelay2g-enabled,
  #cbi-wifirelay-wifirelay2g-notscan {
    display: none;
  }

  .cbi-button-reset {
    display: none;
  }

  .cbi-button-save {
    display: none;
  }

  .cbi-button-apply {
    width: 120px !important;
    height: 40px !important;
    font-size: 18px;
  }

  .wifi_list {
    width: 208px;
    max-height: 150px;
    padding-left: 3px;
    overflow: scroll;
    border: 1px solid rgba(113, 113, 113, 0.2);
  }

  .wifi_list div {
    list-style: none;
    height: 30px;
    line-height: 30px;
    font-size: 14px;
  }

  .btn-update {
    position: fixed;
    bottom: 10px;
    left: 10px;
    height: 50px;
    width: 50px;
  }
</style>
<script>

  var ssidInputEle = document.getElementById('cbid.wifirelay.wifirelay2g.ssid')
  var updateBtnEle = document.createElement('div');
  updateBtnEle.id = 'btn-update';
  updateBtnEle.setAttribute('class', 'btn-update');
  updateBtnEle.onclick = function () {
    var aArray = document.getElementsByTagName('a')
    var i
    for (i = 0; i < aArray.length; i++) {
      if (aArray[i].href.indexOf('system/flashops') > -1) {
        console.log(aArray[i])
        aArray[i].click()
        return;
      }
    }
  }
  ssidInputEle.insertAdjacentElement('afterEnd', updateBtnEle)

  var submitEle = document.getElementsByClassName('cbi-button cbi-button-apply')[0]
  submitEle.setAttribute('value', '连接')

  getWifiList()

  function getWifiList() {
    var url = "http://192.168.11.123/luci-static/xfwuWifiList.txt"
    var xmlHttp;
    if (window.ActiveXObject) {
      try {
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
        xmlHttp = false;
      }
    } else {

      try {
        xmlHttp = new XMLHttpRequest();
      } catch (e) {
        xmlHttp = false;
      }
    }
    if (!xmlHttp) {
      console.log("返回创建的对象或显示错误信息");
    }
    xmlHttp.onreadystatechange = function () {
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
        var str = xmlHttp.responseText;
        var re = new RegExp("(?=\\d+).*(.+\\:)", "g");
        var myArray = str.match(re);
        var wifiList = []
        myArray.forEach(item => {
          var temp = item.split(/\s+/)
          if (temp.length > 2) {
            wifiList.push(temp[1])
          }
        })
        var ssidInputEle = document.getElementById('cbid.wifirelay.wifirelay2g.ssid')
        var wifiListDiv = document.createElement('div');
        wifiListDiv.id = 'wifi_list';
        wifiListDiv.setAttribute('class', 'hide');
        var htmlStr = ''
        for (i = 0; i < wifiList.length; i++) {
          htmlStr += `<div onclick="setWifiName('${wifiList[i]}')">${wifiList[i]}</div>`
        }
        wifiListDiv.innerHTML = htmlStr
        ssidInputEle.insertAdjacentElement('afterEnd', wifiListDiv)

        ssidInputEle.addEventListener("focus", function () {
          wifiListDiv.setAttribute('class', 'wifi_list')
        })

        ssidInputEle.addEventListener("focusout", function () {
          setTimeout(function () {
            wifiListDiv.setAttribute('class', 'hide')
          }, 300)
        })


      }
    }
    xmlHttp.open("GET", url, true);
    xmlHttp.send(null);
  }
  function setWifiName(name) {
    document.getElementById('cbid.wifirelay.wifirelay2g.ssid').value = name
  }

  function upgradePage() {
    var aArray = document.getElementsByTagName("a")
    console.log(aArray)
  }
</script>
</body>

</html>